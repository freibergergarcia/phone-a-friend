name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-node:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ["20", "22"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - run: npm ci
      - name: Check version sync
        run: |
          pkg_ver=$(node -e "console.log(require('./package.json').version)")
          plugin_ver=$(node -e "console.log(require('./.claude-plugin/plugin.json').version)")
          if [ "$pkg_ver" != "$plugin_ver" ]; then
            echo "::error::Version mismatch: package.json=$pkg_ver plugin.json=$plugin_ver"
            exit 1
          fi
      - name: Check dist is up to date
        run: |
          npm run build
          if ! git diff --quiet dist/; then
            echo "::error::dist/ is out of date â€” run 'npm run build' and commit"
            exit 1
          fi
      - name: Verify dist is self-contained
        run: |
          mv node_modules node_modules_bak
          node dist/index.js --version
          mv node_modules_bak node_modules
      - run: npm test
      - run: npm run typecheck

  tests:
    needs: [test-node]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test-node.result }}" != "success" ]; then
            exit 1
          fi
